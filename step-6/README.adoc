= 发布一个web API

TIP: 相应的源代码位于指南存储库的 `step-6` 文件夹中。

使用我们已经从 `vertx-web` 模块中已经介绍的内容，发布一个Web HTTP/JSON API非常简单。 我们将使用以下URL方案发布一个Web API：

* `GET /api/pages` 给出所有的wiki页面名称和标识符的信息,
* `POST /api/pages` 创建一个新的wiki页面，
* `PUT /api/pages/:id` 更新一个wiki页面，
* `DELETE /api/pages/:id` 删除一个wiki页面。

以下是使用 https://httpie.org/[HTTPie命令行工具] 与API进行交互的屏幕截图：

image::images/webapi-httpie.png[]

== Web sub-routers

We are going to add new route handlers to the `HttpServerVerticle`.
While we could just add handlers to the existing router, we can also take advantage of _sub-routers_.
They allow a router to be mounted as a sub-router of another one, which can be useful for organizing and/or re-using handlers.

Here is the code for the API router:

[source,java,indent=0]
----
include::src/main/java/io/vertx/guides/wiki/http/HttpServerVerticle.java[tags=apiRouter]
----
<1> This is where we mount our router, so requests starting with the `/api` path will be directed to `apiRouter`.

== Handlers

Here is the code for the different API router handlers.

=== Root resource

[source,java,indent=0]
----
include::src/main/java/io/vertx/guides/wiki/http/HttpServerVerticle.java[tags=apiRoot]
----
<1> We just remap database results in page information entry objects.
<2> The resulting JSON array becomes the value for the `pages` key in the response payload.
<3> `JsonObject#encode()` gives a compact `String` representation of the JSON data.

=== Getting a page

[source,java,indent=0]
----
include::src/main/java/io/vertx/guides/wiki/http/HttpServerVerticle.java[tags=apiGetPage]
----

=== Creating a page

[source,java,indent=0]
----
include::src/main/java/io/vertx/guides/wiki/http/HttpServerVerticle.java[tags=apiCreatePage]
----

This handler and other handlers need to deal with incoming JSON documents.
The following `validateJsonPageDocument` method is a helper for doing validation and early error reporting, so that the remainder of the processing assume the presence of certain JSON entries:

[source,java,indent=0]
----
include::src/main/java/io/vertx/guides/wiki/http/HttpServerVerticle.java[tags=validateJsonPageDocument]
----

=== Updating a page

[source,java,indent=0]
----
include::src/main/java/io/vertx/guides/wiki/http/HttpServerVerticle.java[tags=apiUpdatePage]
----

The `handleSimpleDbReply` method is a helper for finishing the request processing:

[source,java,indent=0]
----
include::src/main/java/io/vertx/guides/wiki/http/HttpServerVerticle.java[tags=handleSimpleDbReply]
----

=== Deleting a page

[source,java,indent=0]
----
include::src/main/java/io/vertx/guides/wiki/http/HttpServerVerticle.java[tags=apiDeletePage]
----

== Unit testing the API

We write a basic test case in the `io.vertx.guides.wiki.http.ApiTest` class.

The preamble consists in preparing the test environment.
The HTTP server verticle needs the database verticle to be running, so we need to deploy both in our test Vert.x context:

[source,java,indent=0]
----
include::src/test/java/io/vertx/guides/wiki/http/ApiTest.java[tags=preamble]
----
<1> We use a different JDBC URL to use an in-memory database for the tests.

The proper test case is a simple scenario where all types of requests are being made.
It creates a page, fetches it, updates it then deletes it:

[source,java,indent=0]
----
include::src/test/java/io/vertx/guides/wiki/http/ApiTest.java[tags=play-with-api]
----

TIP: The test uses `Future` objects composition rather than nested callbacks; the last composition must complete the
async future or the test will eventually time out.
