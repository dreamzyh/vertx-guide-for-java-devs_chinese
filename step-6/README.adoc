= 发布一个web API

TIP: 相应的源代码位于指南存储库的 `step-6` 文件夹中。

使用我们已经从 `vertx-web` 模块中已经介绍的内容，发布一个Web HTTP/JSON API非常简单。 我们将使用以下URL方案发布一个Web API：

* `GET /api/pages` 给出所有的wiki页面名称和标识符的信息,
* `POST /api/pages` 创建一个新的wiki页面，
* `PUT /api/pages/:id` 更新一个wiki页面，
* `DELETE /api/pages/:id` 删除一个wiki页面。

以下是使用 https://httpie.org/[HTTPie命令行工具] 与API进行交互的屏幕截图：

image::images/webapi-httpie.png[]

== Web子路由器

我们将添加新的路由处理器到 `HttpServerVerticle`。虽然我们可以将处理器添加到现有路由器，但我们也可以利用 _子路由器_ 。它们允许路由器作为另一个路由器的子路由器进行安装，这对组织或重新使用处理器非常有用。

以下是API路由器的代码：

[source,java,indent=0]
----
include::src/main/java/io/vertx/guides/wiki/http/HttpServerVerticle.java[tags=apiRouter]
----
<1> 这是我们安装路由器的地方，所以以 `/api` 路径开始的请求将被定向到 `apiRouter` 。

== 处理器

以下是不同API路由器处理器的代码。

=== 根资源

[source,java,indent=0]
----
include::src/main/java/io/vertx/guides/wiki/http/HttpServerVerticle.java[tags=apiRoot]
----
<1> 我们只是在页面信息条目对象中重新映射数据库结果。
<2> 生成的JSON数组成为响应有效负载中的 `pages` 键的值。
<3> `JsonObject#encode()` 为JSON数据提供了紧凑的 `String` 表示形式。

=== Getting a page

[source,java,indent=0]
----
include::src/main/java/io/vertx/guides/wiki/http/HttpServerVerticle.java[tags=apiGetPage]
----

=== Creating a page

[source,java,indent=0]
----
include::src/main/java/io/vertx/guides/wiki/http/HttpServerVerticle.java[tags=apiCreatePage]
----

This handler and other handlers need to deal with incoming JSON documents.
The following `validateJsonPageDocument` method is a helper for doing validation and early error reporting, so that the remainder of the processing assume the presence of certain JSON entries:

[source,java,indent=0]
----
include::src/main/java/io/vertx/guides/wiki/http/HttpServerVerticle.java[tags=validateJsonPageDocument]
----

=== Updating a page

[source,java,indent=0]
----
include::src/main/java/io/vertx/guides/wiki/http/HttpServerVerticle.java[tags=apiUpdatePage]
----

The `handleSimpleDbReply` method is a helper for finishing the request processing:

[source,java,indent=0]
----
include::src/main/java/io/vertx/guides/wiki/http/HttpServerVerticle.java[tags=handleSimpleDbReply]
----

=== Deleting a page

[source,java,indent=0]
----
include::src/main/java/io/vertx/guides/wiki/http/HttpServerVerticle.java[tags=apiDeletePage]
----

== Unit testing the API

We write a basic test case in the `io.vertx.guides.wiki.http.ApiTest` class.

The preamble consists in preparing the test environment.
The HTTP server verticle needs the database verticle to be running, so we need to deploy both in our test Vert.x context:

[source,java,indent=0]
----
include::src/test/java/io/vertx/guides/wiki/http/ApiTest.java[tags=preamble]
----
<1> We use a different JDBC URL to use an in-memory database for the tests.

The proper test case is a simple scenario where all types of requests are being made.
It creates a page, fetches it, updates it then deletes it:

[source,java,indent=0]
----
include::src/test/java/io/vertx/guides/wiki/http/ApiTest.java[tags=play-with-api]
----

TIP: The test uses `Future` objects composition rather than nested callbacks; the last composition must complete the
async future or the test will eventually time out.
